<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TudoXpress — Loja (HTML único, offline)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0c0f; --surface:#0f1113; --muted:#98a2b3; --card:#0f1316;
    --accent:#6c2bd9; /* roxo */
    --accent-2:#8b5cf6; --ok:#22c55e; --danger:#ef4444; --brand:#6c2bd9;
    --glass: rgba(255,255,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#0b0c10 0%,#0b0f14 100%);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1180px;margin:18px auto;padding:18px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#4419c0,#6c2bd9);padding:12px 18px;border-radius:14px;display:flex;align-items:center;gap:16px;justify-content:space-between;box-shadow:0 8px 24px rgba(108,43,217,.35)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{ width:42px;height:42px;border-radius:10px;background:#fff1;border:1px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px }
  h1{margin:0;font-size:18px}
  .nav{display:flex;gap:10px;align-items:center}
  .btn{background:#20d27c;border:0;color:#08131a;padding:9px 12px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.18);color:#fff;padding:9px 10px;border-radius:10px;cursor:pointer}
  .small{font-size:13px;color:#bcc7d3}

  /* barra hero */
  .hero{background:linear-gradient(180deg, rgba(108,43,217,.18), rgba(139,92,246,.08));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);margin-top:14px}
  .search{display:flex;gap:8px;margin-top:12px}
  .search input{flex:1;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:#0e1117;color:inherit}
  .search select{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:#0e1117;color:inherit}

  main{display:grid;grid-template-columns:1fr 340px;gap:20px;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.06), transparent);padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,0.08)}
  img.prod{width:100%;height:160px;object-fit:cover;border-radius:10px}
  .pname{font-weight:700;margin:8px 0 4px}
  .price{font-weight:900;color:#fff}
  .card .meta{color:#a6b0bd;font-size:13px}
  .qty{width:72px;padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:#0e1117;color:inherit}

  /* filtros */
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .chip{padding:7px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,0.08);font-size:13px;cursor:pointer}

  /* sidebar */
  aside{position:relative}
  .sidecard{background:linear-gradient(180deg, rgba(255,255,255,0.06), transparent);padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,0.08)}
  .cart-list{max-height:380px;overflow:auto;margin-top:8px}
  .cart-item{display:flex;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.08)}
  .cart-item img{width:56px;height:48px;object-fit:cover;border-radius:8px}
  .total{display:flex;justify-content:space-between;align-items:center;margin-top:12px}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(3,6,9,0.6);display:flex;align-items:center;justify-content:center;padding:18px;z-index:80}
  .dialog{background:linear-gradient(180deg,#0c1118,#0c1219);padding:18px;border-radius:16px;width:100%;max-width:920px;border:1px solid rgba(255,255,255,0.08)}
  .row{display:flex;gap:12px}
  .col{flex:1}
  input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:#0e1117;color:inherit}
  label{display:block;font-size:13px;margin-bottom:6px;color:#a6b0bd}
  .admin-bar{display:flex;gap:8px;align-items:center}
  footer{margin-top:18px;color:#a6b0bd;font-size:13px;text-align:center}

  /* mini galeria no modal */
  .thumbs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .thumbs img{width:70px;height:58px;object-fit:cover;border-radius:8px;opacity:.8;border:1px solid rgba(255,255,255,0.12);cursor:pointer}
  .thumbs img.active{opacity:1;outline:2px solid var(--accent-2)}

  @media (max-width:980px){main{grid-template-columns:1fr} aside{order:2} .hero{padding:12px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">TX</div>
      <div>
        <h1>TudoXpress</h1>
        <div class="small">Catálogo + Carrinho + Checkout PIX • Offline</div>
      </div>
    </div>
    <div class="nav">
      <button class="btn-ghost" onclick="openAdmin()">Admin</button>
      <button class="btn" onclick="openCart()">Carrinho (<span id="cartCount">0</span>)</button>
    </div>
  </header>

  <section class="hero">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0">Todos os produtos</h2>
        <div class="small">Filtre, adicione ao carrinho e finalize com PIX</div>
      </div>
      <div style="text-align:right">
        <div class="small">Atendimento WhatsApp</div>
        <div style="font-weight:800">+55 38 99829-7529</div>
      </div>
    </div>
    <div class="search" style="margin-top:12px">
      <input id="searchInput" placeholder="O que está buscando?" oninput="renderProducts()" />
      <select id="catFilter" onchange="renderProducts()">
        <option value="">Todas categorias</option>
      </select>
      <button class="btn-ghost" onclick="toggleView()" title="Trocar visualização">▦</button>
      <button class="btn" onclick="renderProducts()">Buscar</button>
    </div>
  </section>

  <main>
    <section>
      <div class="filters" id="categoriesBox"></div>
      <div id="grid" class="grid"></div>
    </section>

    <aside>
      <div class="sidecard">
        <h3 style="margin:0">Seu carrinho</h3>
        <div class="cart-list" id="cartList"></div>
        <div class="total">
          <div>
            <div class="small">Subtotal</div>
            <div id="subtotalText" style="font-weight:900">R$ 0,00</div>
          </div>
          <div>
            <button class="btn" onclick="goToCheckout()">Finalizar</button>
          </div>
        </div>
        <div style="margin-top:12px" class="small">Frete calculado no checkout por CEP.</div>
      </div>

      <div style="height:14px"></div>

      <div class="sidecard">
        <h4 style="margin:0">PIX / Pagamento</h4>
        <div class="small" style="margin-top:6px">Chave: <b id="pixKeyView">+5538998297529</b></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn-ghost" onclick="openCheckout()">Pagar via PIX</button>
          <button class="btn-ghost" onclick="copyToClipboard('+5538998297529')">Copiar chave</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    © <span id="year"></span> TudoXpress — HTML único • Admin: admin/admin
  </footer>
</div>

<!-- CART & CHECKOUT MODAL -->
<div id="cartModal" class="modal" style="display:none">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Carrinho</h3>
      <div><button class="btn-ghost" onclick="closeCart()">Fechar</button></div>
    </div>
    <div id="cartModalBody" style="margin-top:12px"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-ghost" onclick="clearCart()">Esvaziar</button>
      <button class="btn" onclick="goToCheckoutFromModal()">Ir para checkout</button>
    </div>
  </div>
</div>

<div id="checkoutModal" class="modal" style="display:none">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Checkout</h3>
      <div><button class="btn-ghost" onclick="closeCheckout()">Fechar</button></div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <label>Nome completo</label>
        <input id="c_nome" placeholder="Nome completo"/>
        <label style="margin-top:8px">WhatsApp (com DDD)</label>
        <input id="c_whats" placeholder="559899999999"/>
        <label style="margin-top:8px">CEP</label>
        <input id="c_cep" placeholder="00000000" onblur="calcFreteCheckout()"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Endereço</label>
            <input id="c_end" placeholder="Rua, número"/>
          </div>
          <div style="width:120px">
            <label>UF</label>
            <input id="c_uf" placeholder="MG"/>
          </div>
        </div>
        <label style="margin-top:8px">Observação</label>
        <textarea id="c_obs" rows="3" placeholder="Observação para entrega"></textarea>
      </div>

      <div style="width:340px;margin-left:12px">
        <div style="background:rgba(255,255,255,0.06);padding:12px;border-radius:12px">
          <div style="display:flex;justify-content:space-between">
            <div class="small">Resumo</div>
            <div class="small">Itens: <span id="checkoutItems">0</span></div>
          </div>
          <div style="margin-top:6px">
            <div class="small">Subtotal</div>
            <div id="checkoutSubtotal" style="font-weight:900">R$ 0,00</div>
          </div>
          <div style="margin-top:8px">
            <div class="small">Frete</div>
            <div id="checkoutFrete">R$ 0,00</div>
          </div>
          <div style="margin-top:8px;border-top:1px dashed rgba(255,255,255,0.12);padding-top:8px">
            <div style="display:flex;justify-content:space-between">
              <div>Total</div>
              <div id="checkoutTotal" style="font-weight:900">R$ 0,00</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Chave PIX</label>
            <input id="pixKeyInput" value="+5538998297529" />
            <label style="margin-top:8px">Upload do QR (opcional)</label>
            <input id="pixQRupload" type="file" accept="image/*" />
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn" onclick="confirmPix()">Concluir com PIX</button>
              <button class="btn-ghost" onclick="confirmCash()">Concluir (marcar)</button>
            </div>
            <div class="small" style="margin-top:8px">Ao concluir, o pedido será salvo no painel Admin.</div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRODUCT DETAILS MODAL -->
<div id="productModal" class="modal" style="display:none">
  <div class="dialog" id="productDialog"></div>
</div>

<!-- ADMIN LOGIN / PANEL -->
<div id="adminModal" class="modal" style="display:none">
  <div class="dialog">
    <div id="adminBody"></div>
  </div>
</div>

<script>
/* ========= Simple local "DB" using localStorage ========= */
const DB = {
  productsKey: 'tx_products_v3',
  cartKey: 'tx_cart_v2',
  ordersKey: 'tx_orders_v2'
};
const read = (k) => JSON.parse(localStorage.getItem(k) || 'null');
const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const uid = ()=> 'ID'+Date.now().toString(36).slice(-8);
const money = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
let compactView = false; function toggleView(){ compactView=!compactView; renderProducts(); }

/* ======= Initial seeding (if empty) ======= */
if(!read(DB.productsKey)){
  // PRODUTO NOVO — Ring Light (com galeria de imagens)
  const RING_DESC = `Ilumine seus vídeos e fotos como um profissional!\n\nO **Ring Light Tripé Profissional 360º** é perfeito para criadores de conteúdo, maquiadores e quem busca qualidade nas gravações.\n\n• 3 modos de luz (fria, quente e neutra) + 10 níveis de intensidade\n• Tripé ajustável e cabeça com giro 360º\n• Suporte para celular incluso (largura 7–10cm)\n• Alimentação USB — plug & play\n\nLeve sua produção para outro nível por apenas **R$ 79,99**.`;
  write(DB.productsKey, [
    { id: uid(), title:'Ring Light Tripé Profissional 360º', price:79.99, cat:'Eletrônicos', sku:'RING-12',
      // Dica: troque as URLs abaixo pelas suas (ou cole data:image/... base64)
      img: 'https://images.unsplash.com/photo-1585247226801-bc613c441316?q=80&w=1200&auto=format&fit=crop',
      imgs:[
        'https://images.unsplash.com/photo-1585247226801-bc613c441316?q=80&w=1200&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1593642632823-8f785ba67e45?q=80&w=1200&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1200&auto=format&fit=crop'
      ],
      desc: RING_DESC },
    // Alguns itens de exemplo para completar o catálogo
    {id:uid(), title:'Mini Ventilador Portátil', price:89.9, cat:'Eletrônicos', sku:'VENT-01', img:'https://images.unsplash.com/photo-1569079622229-9f29f5a6f2a0?q=80&w=900&auto=format&fit=crop', desc:'Ventilador USB recarregável, 3 velocidades.'},
    {id:uid(), title:'Iluminador Magnético para Celular', price:79.9, cat:'Acessórios', sku:'LIGHT-02', img:'https://images.unsplash.com/photo-1545239351-1141bd82e8a6?q=80&w=900&auto=format&fit=crop', desc:'Light ring compacto, fácil de fixar.'},
    {id:uid(), title:'Brinquedo Automático para Gatos', price:99.9, cat:'Pet', sku:'PET-03', img:'https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=900&auto=format&fit=crop', desc:'Diversão para seu gato por horas.'},
    {id:uid(), title:'Lâmpada Robô de Madeira (Decor)', price:189.9, cat:'Decoração', sku:'DECO-04', img:'https://images.unsplash.com/photo-1505691723518-36a8ad8a67a0?q=80&w=900&auto=format&fit=crop', desc:'Peça de decoração elegante.'},
    {id:uid(), title:'Fatiador + Garfo de Melancia', price:39.9, cat:'Cozinha', sku:'KITCH-05', img:'https://images.unsplash.com/photo-1568051243852-2c7f9c9f8c7f?q=80&w=900&auto=format&fit=crop', desc:'Corte rápido e sem bagunça.'}
  ]);
}
if(!read(DB.cartKey)) write(DB.cartKey, []);
if(!read(DB.ordersKey)) write(DB.ordersKey, []);

/* ======= Render helpers ======= */
function getProducts(){ return read(DB.productsKey) || []; }
function saveProducts(p){ write(DB.productsKey,p); renderProducts(); }
function getCart(){ return read(DB.cartKey) || []; }
function saveCart(c){ write(DB.cartKey,c); renderCartUI(); updateCartCount(); }
function getOrders(){ return read(DB.ordersKey) || []; }
function saveOrders(o){ write(DB.ordersKey,o); }

/* ======= UI render ======= */
function renderProducts(){
  const grid = document.getElementById('grid');
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  const cat = document.getElementById('catFilter').value;
  let products = getProducts().filter(p=>{
    if(cat && p.cat !== cat) return false;
    if(!q) return true;
    return p.title.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q) || (p.cat||'').toLowerCase().includes(q);
  });
  if(!products.length){ grid.innerHTML = '<div style="grid-column:1/-1" class="small">Nenhum produto encontrado</div>'; return; }
  grid.className = compactView ? 'grid compact' : 'grid';
  grid.innerHTML = products.map(p=>`
    <div class="card">
      <img class="prod" src="${(p.imgs && p.imgs[0]) || p.img}" alt="${p.title}" />
      <div class="pname">${p.title}</div>
      <div class="meta">${p.cat} • ${p.sku||''}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="price">${money(p.price)}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="qty" id="qty_${p.id}" type="number" min="1" value="1" />
          <button class="btn" onclick="addToCart('${p.id}')">Adicionar</button>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;justify-content:space-between">
        <button class="btn-ghost" onclick="openProduct('${p.id}')">Ver</button>
        <button class="btn-ghost" onclick="openAdmin(true,'edit','${p.id}')">Editar</button>
      </div>
    </div>
  `).join('');
  renderCategories();
}

/* ======= Categories & filters ======= */
function renderCategories(){
  const cats = {};
  getProducts().forEach(p=>cats[p.cat] = (cats[p.cat]||0)+1);
  const catFilter = document.getElementById('catFilter');
  const box = document.getElementById('categoriesBox');
  catFilter.innerHTML = '<option value="">Todas categorias</option>' + Object.keys(cats).map(c=>`<option value="${c}">${c} (${cats[c]})</option>`).join('');
  box.innerHTML = Object.keys(cats).map(c=>`<div class="chip" onclick="document.getElementById('catFilter').value='${c}'; renderProducts();">${c} (${cats[c]})</div>`).join('');
}

/* ======= Cart actions ======= */
function addToCart(id){
  const el = document.getElementById('qty_'+id);
  const qty = Math.max(1, parseInt(el? el.value: 1));
  const cart = getCart();
  const idx = cart.findIndex(i=>i.id===id);
  if(idx>=0) cart[idx].q += qty; else cart.push({id,q:qty});
  saveCart(cart);
  alert('Produto adicionado ao carrinho');
}
function renderCartUI(){
  const list = document.getElementById('cartList');
  const cart = getCart();
  if(!cart.length){ list.innerHTML = '<div class="small">Carrinho vazio</div>'; document.getElementById('subtotalText').textContent = 'R$ 0,00'; updateCartCount(); return; }
  const products = getProducts();
  list.innerHTML = cart.map(it=>{
    const p = products.find(x=>x.id===it.id) || {};
    return `<div class="cart-item">
      <img src="${(p.imgs && p.imgs[0]) || p.img || ''}" alt="">
      <div style="flex:1">
        <div style="font-weight:700">${p.title||'Produto'}</div>
        <div class="meta">${p.sku||''} • ${money(p.price||0)}</div>
        <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
          <input style="width:72px;padding:6px;border-radius:8px" type="number" min="1" value="${it.q}" onchange="changeQty('${it.id}',this.value)" />
          <button class="btn-ghost" onclick="removeFromCart('${it.id}')">Remover</button>
        </div>
      </div>
      <div style="text-align:right">${money(((p.price||0)*it.q)||0)}</div>
    </div>`;
  }).join('');
  const subtotal = cart.reduce((s,i)=> {
    const p = getProducts().find(x=>x.id===i.id);
    return s + ((p?.price||0)*i.q);
  },0);
  document.getElementById('subtotalText').textContent = money(subtotal);
  document.getElementById('checkoutSubtotal').textContent = money(subtotal);
  updateCartCount();
}
function changeQty(id,val){ const cart=getCart(); const it=cart.find(i=>i.id===id); if(!it) return; it.q=Math.max(1,parseInt(val||1)); saveCart(cart); renderCartUI(); }
function removeFromCart(id){ let cart=getCart(); cart=cart.filter(i=>i.id!==id); saveCart(cart); renderCartUI(); }
function clearCart(){ if(!confirm('Esvaziar carrinho?')) return; saveCart([]); renderCartUI(); }
function updateCartCount(){ const count = getCart().reduce((s,i)=>s+i.q,0); document.getElementById('cartCount').textContent = count; }

/* ======= Modals ======= */
function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCartModal(); }
function closeCart(){ document.getElementById('cartModal').style.display='none'; }
function renderCartModal(){
  const body = document.getElementById('cartModalBody');
  const cart = getCart();
  if(!cart.length){ body.innerHTML='<div class="small">Carrinho vazio</div>'; return; }
  const products = getProducts();
  body.innerHTML = cart.map(it=>{
    const p = products.find(x=>x.id===it.id)||{};
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.12)">
      <div>${it.q}x <b>${p.title||'Produto'}</b></div>
      <div>${money(((p.price||0)*it.q)||0)}</div>
    </div>`;
  }).join('') + `<div style="margin-top:10px;display:flex;justify-content:flex-end"><button class="btn" onclick="goToCheckoutFromModal()">Finalizar</button></div>`;
}

function openProduct(id){
  const p = getProducts().find(x=>x.id===id);
  if(!p) return;
  const dialog = document.getElementById('productDialog');
  const imgs = p.imgs && p.imgs.length ? p.imgs : [p.img];
  const main = imgs[0];
  dialog.innerHTML = `
    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <img id="prod_main" src="${main}" style="width:100%;border-radius:12px;max-height:420px;object-fit:cover" />
        <div class="thumbs">${imgs.map((u,i)=>`<img src="${u}" class="${i===0?'active':''}" onclick=\"setMain('${u}',this)\">`).join('')}</div>
      </div>
      <div style="width:440px;max-width:100%">
        <h2 style="margin:0">${p.title}</h2>
        <div class="small" style="margin-top:6px">${p.cat} • ${p.sku||''}</div>
        <div style="margin-top:12px;white-space:pre-wrap">${p.desc||''}</div>
        <div style="margin-top:12px;font-weight:900">${money(p.price)}</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="modal_qty" type="number" value="1" min="1" style="width:100px;padding:9px;border-radius:10px"/>
          <button class="btn" onclick="(function(){ addModalToCart('${p.id}') })()">Adicionar ao carrinho</button>
          <button class="btn-ghost" onclick="openAdmin(true,'edit','${p.id}')">Editar</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('productModal').style.display='flex';
}
function setMain(url,thumb){ document.getElementById('prod_main').src=url; document.querySelectorAll('.thumbs img').forEach(i=>i.classList.remove('active')); thumb.classList.add('active'); }
function addModalToCart(id){
  const q = Math.max(1,parseInt(document.getElementById('modal_qty').value||1));
  const cart = getCart(); const idx = cart.findIndex(i=>i.id===id);
  if(idx>=0) cart[idx].q += q; else cart.push({id,q});
  saveCart(cart); alert('Adicionado ao carrinho'); document.getElementById('productModal').style.display='none';
}
function closeProduct(){ document.getElementById('productModal').style.display='none'; }

/* ======= Checkout flow ======= */
function goToCheckout(){
  document.getElementById('cartModal').style.display='none';
  document.getElementById('checkoutModal').style.display='flex';
  const cart = getCart();
  document.getElementById('checkoutItems').textContent = cart.reduce((s,i)=>s+i.q,0);
  const subtotal = cart.reduce((s,i)=> { const p = getProducts().find(x=>x.id===i.id); return s + ((p?.price||0)*i.q); },0);
  document.getElementById('checkoutSubtotal').textContent = money(subtotal);
  document.getElementById('checkoutFrete').textContent = 'R$ 0,00';
  document.getElementById('checkoutTotal').textContent = money(subtotal);
}
function goToCheckoutFromModal(){ closeCart(); goToCheckout(); }
function closeCheckout(){ document.getElementById('checkoutModal').style.display='none'; }

// Frete simples por CEP (demo)
function calcFreteCheckout(){
  const cep = (document.getElementById('c_cep').value || '').replace(/\D/g,'');
  if(cep.length!==8){ alert('Informe CEP válido (8 dígitos)'); return; }
  const first = parseInt(cep[0],10);
  let frete = 19.90;
  if(first===9) frete = 29.90;
  else if(first>=4 && first<=6) frete = 24.90;
  else if(first===7 || first===8) frete = 22.90;
  const subtotal = getCart().reduce((s,i)=>{ const p=getProducts().find(x=>x.id===i.id); return s+((p?.price||0)*i.q); },0);
  if(subtotal >= 250) frete = 0;
  document.getElementById('checkoutFrete').textContent = money(frete);
  document.getElementById('checkoutTotal').textContent = money(subtotal + frete);
}

/* ======= Confirm purchase ======= */
function confirmPix(){
  const key = document.getElementById('pixKeyInput').value.trim();
  const qrFile = document.getElementById('pixQRupload').files[0];
  const nome = document.getElementById('c_nome').value.trim();
  const whats = document.getElementById('c_whats').value.trim();
  const cep = document.getElementById('c_cep').value.trim();
  if(!nome || !whats || !cep){ alert('Preencha nome, WhatsApp e CEP'); return; }
  finalizeOrder('PIX', key, qrFile);
}
function confirmCash(){ finalizeOrder('PIX (marcado)', document.getElementById('pixKeyInput').value.trim(), null); }

function finalizeOrder(method, key, qrFile){
  const cart = getCart();
  if(!cart.length){ alert('Carrinho vazio'); return; }
  const nome = document.getElementById('c_nome').value.trim();
  const whats = document.getElementById('c_whats').value.trim();
  const cep = document.getElementById('c_cep').value.trim();
  const end = document.getElementById('c_end').value.trim();
  const uf = document.getElementById('c_uf').value.trim();
  const obs = document.getElementById('c_obs').value.trim();
  const subtotal = cart.reduce((s,i)=>{ const p=getProducts().find(x=>x.id===i.id); return s+((p?.price||0)*i.q); },0);
  let frete = parseFloat(document.getElementById('checkoutFrete').textContent.replace(/[^\d\.\,]/g,'').replace(',','.')||0) || 0;
  const total = +(subtotal + frete).toFixed(2);

  const order = {
    id: uid(),
    date: new Date().toLocaleString(),
    customer:{nome,whats,cep,end,uf,obs},
    items: cart.map(i=>{ const p=getProducts().find(x=>x.id===i.id); return {id:p.id,title:p.title,price:p.price,q:i.q,subtotal: +(p.price*i.q).toFixed(2)} }),
    totals:{subtotal:+subtotal.toFixed(2),frete:+frete.toFixed(2),total},
    payment:{method,key}
  };

  if(qrFile){
    const reader = new FileReader();
    reader.onload = function(e){ order.payment.qr = e.target.result; pushOrder(order); };
    reader.readAsDataURL(qrFile);
  } else { pushOrder(order); }
}

function pushOrder(order){
  const orders = getOrders();
  orders.unshift(order);
  saveOrders(orders);
  saveCart([]);
  renderCartUI();
  alert('Pedido registrado: ' + order.id);
  closeCheckout();
  openAdmin(true,'orders');
  const msg = buildWhatsMsg(order);
  const wa = 'https://wa.me/' + order.customer.whats.replace(/\D/g,'') + '?text=' + encodeURIComponent(msg);
  if(confirm('Deseja abrir WhatsApp para enviar mensagem de confirmação ao cliente?')) window.open(wa,'_blank');
}

function buildWhatsMsg(order){
  const lines = [];
  lines.push(`Olá ${order.customer.nome}, seu pedido foi recebido!`);
  lines.push(`Pedido: ${order.id}`);
  lines.push('');
  lines.push('Itens:');
  order.items.forEach(it=> lines.push(`${it.q}x ${it.title} — ${money(it.price)} (subtotal ${money(it.subtotal)})`));
  lines.push('');
  lines.push(`Subtotal: ${money(order.totals.subtotal)}`);
  lines.push(`Frete: ${money(order.totals.frete)}`);
  lines.push(`TOTAL: ${money(order.totals.total)}`);
  lines.push('');
  lines.push('Enviaremos confirmação do pagamento em breve. Obrigado por comprar na TudoXpress!');
  return lines.join('\n');
}

/* ======= Admin panel ======= */
let adminOpen = false;
function openAdmin(skipLogin, action, id){
  adminOpen = true;
  document.getElementById('adminModal').style.display='flex';
  const body = document.getElementById('adminBody');
  const logged = sessionStorage.getItem('tx_admin_logged') === '1';
  if(!logged && !skipLogin){
    body.innerHTML = `
      <h3>Login Admin</h3>
      <label>Usuário</label><input id="adm_user" value="" />
      <label style="margin-top:8px">Senha</label><input id="adm_pass" type="password" />
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn-ghost" onclick="document.getElementById('adminModal').style.display='none'">Fechar</button>
        <button class="btn" onclick="adminLogin()">Entrar</button>
      </div>
      <div class="small" style="margin-top:8px">Credenciais: admin / admin</div>
    `;
    return;
  }
  const products = getProducts();
  const orders = getOrders();
  body.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Painel Admin</h3>
      <div class="admin-bar">
        <button class="btn-ghost" onclick="sessionStorage.removeItem('tx_admin_logged'); alert('Logout'); openAdmin();">Logout</button>
        <button class="btn" onclick="document.getElementById('adminModal').style.display='none'">Fechar</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:420px">
        <h4>Produtos</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="openAdmin(true,'create')">Novo produto</button>
          <button class="btn-ghost" onclick="exportProducts()">Exportar JSON</button>
          <button class="btn-ghost" onclick="importProducts()">Importar JSON</button>
        </div>
        <div style="margin-top:8px">
          <table style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:left">Produto</th><th>Preço</th><th style="text-align:left">Ações</th></tr></thead>
            <tbody id="adminProducts">${products.map(p=>`<tr><td>${p.title} <div class='small'>${p.cat} • ${p.sku||''}</div></td><td style='font-weight:700'>${money(p.price)}</td><td><button class='btn-ghost' onclick="openAdmin(true,'edit','${p.id}')">Editar</button> <button class='btn-ghost' onclick="deleteProduct('${p.id}')">Remover</button></td></tr>`).join('')}</tbody>
          </table>
        </div>
      </div>

      <div style="width:420px;max-width:100%">
        <h4>Pedidos (${orders.length})</h4>
        <div style="max-height:420px;overflow:auto">
          ${orders.map(o=>`<div style="padding:10px;border-bottom:1px dashed rgba(255,255,255,0.12)"><div style="display:flex;justify-content:space-between"><div><b>${o.id}</b><div class='small'>${o.customer.nome} • ${o.customer.whats}</div></div><div>${money(o.totals.total)}</div></div><div style='margin-top:8px'><button class='btn-ghost' onclick="viewOrder('${o.id}')">Ver</button></div></div>`).join('')}
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn-ghost" onclick="clearOrders()">Limpar pedidos (demo)</button>
        </div>
      </div>
    </div>
  `;
  if(action==='create'){ renderProductForm(); }
  if(action==='edit' && id){ renderProductForm(id); }
}

function adminLogin(){
  const u = document.getElementById('adm_user').value.trim();
  const p = document.getElementById('adm_pass').value.trim();
  if(u==='admin' && p==='admin'){ sessionStorage.setItem('tx_admin_logged','1'); openAdmin(true); } else alert('Credenciais incorretas');
}

function renderProductForm(editId){
  const body = document.getElementById('adminBody');
  const p = getProducts().find(x=>x.id===editId);
  body.innerHTML = `
    <h3>${p? 'Editar produto':'Criar produto'}</h3>
    <label>Título</label><input id="adm_title" value="${p?escapeHtml(p.title):''}" />
    <label>Categoria</label><input id="adm_cat" value="${p?escapeHtml(p.cat):''}" />
    <label>SKU</label><input id="adm_sku" value="${p?escapeHtml(p.sku):''}" />
    <label>Preço</label><input id="adm_price" type="number" step="0.01" value="${p?p.price:''}" />
    <label>Imagem principal (URL ou data:image)</label><input id="adm_img" value="${p?escapeHtml(p.img):''}" />
    <label>Galeria (1 por linha — URLs ou data:image)</label><textarea id="adm_imgs" rows="5">${p&&(p.imgs||[]).join('\n')||''}</textarea>
    <label>Descrição</label><textarea id="adm_desc" rows="6">${p?escapeHtml(p.desc):''}</textarea>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn-ghost" onclick="openAdmin(true)">Voltar</button>
      <button class="btn" onclick="saveProduct('${p?p.id:''}')">Salvar</button>
    </div>
    <div class="small" style="margin-top:8px">Dica: você pode colar **data:image/jpeg;base64,*** diretamente para usar imagens locais em um único arquivo.</div>
  `;
}

function saveProduct(id){
  const title = document.getElementById('adm_title').value.trim();
  const cat = document.getElementById('adm_cat').value.trim();
  const sku = document.getElementById('adm_sku').value.trim();
  const price = parseFloat(document.getElementById('adm_price').value||0);
  const img = document.getElementById('adm_img').value.trim();
  const imgs = (document.getElementById('adm_imgs').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const desc = document.getElementById('adm_desc').value.trim();
  if(!title || !price){ alert('Preencha título e preço'); return; }
  const products = getProducts();
  if(id){
    const idx = products.findIndex(p=>p.id===id);
    if(idx>=0){ products[idx] = {id,title,cat,sku,price,img,imgs,desc}; }
  } else {
    products.unshift({id:uid(),title,cat,sku,price,img,imgs,desc});
  }
  saveProducts(products);
  openAdmin(true);
}

function deleteProduct(id){ if(!confirm('Remover produto?')) return; const products = getProducts().filter(p=>p.id!==id); saveProducts(products); openAdmin(true); }

function exportProducts(){ const data = JSON.stringify(getProducts(),null,2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='produtos_tudoxpress.json'; a.click(); URL.revokeObjectURL(url); }

function importProducts(){ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=()=>{ const file=input.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=e=>{ try{ const arr=JSON.parse(e.target.result); if(Array.isArray(arr)){ saveProducts(arr); alert('Importado com sucesso'); openAdmin(true); } else alert('Arquivo inválido'); }catch(err){ alert('Erro no arquivo'); } }; reader.readAsText(file); }; input.click(); }

/* View order in admin */
function viewOrder(id){
  const order = getOrders().find(o=>o.id===id);
  if(!order) return alert('Pedido não encontrado');
  let html = `<h3>Pedido ${order.id}</h3><div class="small">Data: ${order.date}</div><div style="margin-top:8px"><b>Cliente</b><div>${order.customer.nome} • ${order.customer.whats}</div><div>${order.customer.end} • ${order.customer.cep}</div></div><div style="margin-top:8px"><b>Itens</b>`;
  order.items.forEach(it=> html += `<div>${it.q}x ${it.title} — ${money(it.price)} (subtotal ${money(it.subtotal)})</div>`);
  html += `</div><div style="margin-top:8px"><b>Total</b><div>${money(order.totals.total)}</div></div><div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap"><button class="btn-ghost" onclick="openAdmin(true)">Voltar</button><button class="btn" onclick="printOrder('${id}')">Imprimir romaneio</button> <button class="btn-ghost" onclick="sendToWhats('${id}')">WhatsApp</button></div>`;
  document.getElementById('adminBody').innerHTML = html;
}

/* Clear orders */
function clearOrders(){ if(!confirm('Limpar todos os pedidos?')) return; saveOrders([]); openAdmin(true); }

/* Print romaneio */
function printOrder(id){
  const order = getOrders().find(o=>o.id===id);
  if(!order) return alert('Pedido não encontrado');
  const w = window.open('about:blank','_blank');
  const html = `
    <html><head><title>Romaneio ${order.id}</title></head>
    <body>
      <h2>Romaneio - TudoXpress</h2>
      <div>Pedido: ${order.id}</div>
      <div>Data: ${order.date}</div>
      <h3>Cliente</h3>
      <div>${order.customer.nome} • ${order.customer.whats}</div>
      <div>${order.customer.end} • CEP ${order.customer.cep}</div>
      <h3>Itens</h3>
      ${order.items.map(it=>`<div>${it.q}x ${it.title} — ${money(it.price)}</div>`).join('')}
      <h3>Total: ${money(order.totals.total)}</h3>
    </body></html>`;
  w.document.write(html); w.document.close(); w.print();
}

/* Send whatsapp */
function sendToWhats(id){ const order = getOrders().find(o=>o.id===id); if(!order) return; const msg = buildWhatsMsg(order); const wa = 'https://wa.me/' + order.customer.whats.replace(/\D/g,'') + '?text=' + encodeURIComponent(msg); window.open(wa,'_blank'); }

/* Utilities */
function openAdminLogin(){ openAdmin(); }
function closeAdmin(){ document.getElementById('adminModal').style.display='none'; adminOpen=false; }
function copyToClipboard(text){ navigator.clipboard.writeText(text).then(()=>alert('Copiado!')) }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* init */
function init(){ document.getElementById('year').textContent = new Date().getFullYear(); renderProducts(); renderCartUI(); }
init();

/* small helpers exposed globally for buttons */
window.openCart = openCart; window.openAdmin = ()=>openAdmin(false);
window.openCheckout = ()=>{ goToCheckout(); document.getElementById('checkoutModal').style.display='flex'; };
window.clearCart = clearCart; window.openProduct = openProduct; window.closeProduct = closeProduct;
</script>
</body>
</html>